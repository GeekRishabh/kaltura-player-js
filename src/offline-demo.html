<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <title>Offline Demo</title>
  <link rel="stylesheet" type="text/css" href="./style.css"/>
  <script src="./kaltura-ovp-player.js" type="text/javascript"></script>
</head>
<body>
<section class="downloadSection">
  <div class="container">
    <div id="downloadBtn" class="btn">Download
      <div id="downloadBtnLoader" class="loader hide">Loading...</div>
    </div>
    <div class="bitrateSelectionLabel">Bitrate to download:</div>
    <input id="bitrateSelection1" class="bitrateSelectionInput"/>
  </div>
  <div id="pauseBtn" class="btn">Pause</div>
  <div id="resumeBtn" class="btn">Resume</div>
  <div id="loadPlayerBtn" class="btn">Load player</div>
  <div id="progress"></div>

</section>
<section class="playerCont"><div id="drm-placeholder"></div></section>
<section class="playerCont"><div id="drm2-placeholder"></div></section>
<script>
  var drmConfig = {
    targetId: 'drm-placeholder',
    provider: {
      partnerId: 2222401,
      env: {
        cdnUrl: "http://cdnapisec.kaltura.com/",
        serviceUrl: "http://cdnapisec.kaltura.com/api_v3"
      }
    },
    player: {
      playback: {
        "preload": "none", // "auto"/"none"
        "autoplay": false, // false/true
        "muted": false, // false/true
        "playsinline": true,
        "allowMutedAutoPlay":true, // if autoPlay blocked by browser the video started muted
        "streamPriority": [
          {
            "engine": "html5",
            "format": "dash"
          }
        ]
      }
    }
  };

  var drmConfig2 = {
    targetId: 'drm2-placeholder',
    provider: {
      partnerId: 2222401,
      env: {
        cdnUrl: "http://cdnapisec.kaltura.com/",
        serviceUrl: "http://cdnapisec.kaltura.com/api_v3"
      }
    },
    player: {
      playback: {
        "preload": "none", // "auto"/"none"
        "autoplay": false, // false/true
        "muted": false, // false/true
        "playsinline": true,
        "allowMutedAutoPlay":true, // if autoPlay blocked by browser the video started muted
        "streamPriority": [
          {
            "engine": "html5",
            "format": "dash"
          }
        ]
      }
    }
  };

  var drmEntry = {
    entryId: '1_f93tepsn',
    config: drmConfig
  }


  var drmEntry2 = {
    entryId: '1_f93tepsn',
    config: drmConfig2
  }


  try {

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    var dManager = new KalturaPlayer.offlineManager.OfflineManager(drmConfig);
  } catch (e) {
    console.error(e.message)
  }

  document.getElementById("loadPlayerBtn").addEventListener("click",()=>{
    var kalturaPlayer = KalturaPlayer.setup(drmEntry.config);
    kalturaPlayer.loadMedia({entryId: drmEntry.entryId});
  });

  document.getElementById("downloadBtn").addEventListener("click",()=>{
    dManager.getMediaInfo({entryId: drmEntry.entryId})
      .then(res => {
        let options = {
          trackSelectionCallback: trackSelectionCallback()
        }
        dManager.download(drmEntry.entryId, options);
      });
  });

  document.getElementById("resumeBtn").addEventListener("click",()=>{
    dManager.resume(drmEntry.entryId);
  });

  document.getElementById("pauseBtn").addEventListener("click",()=>{
    dManager.pause(drmEntry.entryId);
  });

  window.addEventListener("progress", event => {
    console.info("entry: ", event.detail.entryId ,"progress", event.detail.progress);
  });


  var bitrateSelectionCallback = tracks => {
    let input = document.getElementById("bitrateSelection1");
    let goal = input.value;
    let closest = tracks.reduce(function(prev, curr) {
      return (Math.abs(curr.bandwidth - goal) < Math.abs(prev.bandwidth - goal) ? curr : prev);
    });
    return [closest];
  };


  var trackSelectionCallback = () => {
    let input = document.getElementById("bitrateSelection1");
    if (!input.value){
      return null; // use shaka's default
    }
    return bitrateSelectionCallback;
  };




</script>
</body>
</html>
